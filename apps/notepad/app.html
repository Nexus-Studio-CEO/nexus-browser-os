<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notepad</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a24;
      color: #e8e8f0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .toolbar {
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px 16px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .toolbar-btn {
      background: rgba(255, 255, 255, 0.05);
      border: none;
      border-radius: 6px;
      color: #e8e8f0;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .toolbar-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .toolbar-btn.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .toolbar-btn.primary:hover {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .toolbar-divider {
      width: 1px;
      height: 24px;
      background: rgba(255, 255, 255, 0.1);
      margin: 0 8px;
    }

    .toolbar-info {
      margin-left: auto;
      font-size: 12px;
      color: #9090a8;
    }

    .editor-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .editor {
      width: 100%;
      height: 100%;
      background: transparent;
      border: none;
      outline: none;
      color: #e8e8f0;
      font-family: 'Courier New', Monaco, monospace;
      font-size: 14px;
      line-height: 1.6;
      resize: none;
    }

    .editor::placeholder {
      color: #9090a8;
    }

    .status-bar {
      background: rgba(0, 0, 0, 0.2);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 8px 16px;
      font-size: 12px;
      color: #9090a8;
      display: flex;
      justify-content: space-between;
    }

    .notification {
      position: fixed;
      bottom: 60px;
      right: 20px;
      background: rgba(102, 126, 234, 0.95);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button class="toolbar-btn primary" id="save-btn">Save</button>
    <button class="toolbar-btn" id="new-btn">New</button>
    <div class="toolbar-divider"></div>
    <button class="toolbar-btn" id="undo-btn">Undo</button>
    <button class="toolbar-btn" id="redo-btn">Redo</button>
    <div class="toolbar-divider"></div>
    <button class="toolbar-btn" id="find-btn">Find</button>
    <div class="toolbar-info">
      <span id="word-count">0 words</span>
      <span style="margin: 0 8px;">|</span>
      <span id="char-count">0 characters</span>
    </div>
  </div>

  <div class="editor-container">
    <textarea class="editor" id="editor" placeholder="Start typing..."></textarea>
  </div>

  <div class="status-bar">
    <span id="status-text">Ready</span>
    <span id="cursor-position">Line 1, Column 1</span>
  </div>

  <div class="notification" id="notification"></div>

  <script>
    // ═══════════════════════════════════════════════
    // NOTEPAD APP
    // ═══════════════════════════════════════════════

    class Notepad {
      constructor() {
        this.editor = document.getElementById('editor');
        this.pid = null;
        this.currentFile = null;
        this.isSaved = true;
        this.undoStack = [];
        this.redoStack = [];
        this.lastContent = '';

        this.init();
      }

      init() {
        this.setupEventListeners();
        this.updateStats();
        this.notifyParentReady();

        window.addEventListener('message', (e) => {
          const { type, data } = e.data;

          if (type === 'kernel:config') {
            this.pid = data.pid;
            console.log('[Notepad] Received config, PID:', this.pid);
          }
        });

        // Auto-save every 30 seconds
        setInterval(() => {
          if (!this.isSaved) {
            this.autoSave();
          }
        }, 30000);
      }

      setupEventListeners() {
        const saveBtn = document.getElementById('save-btn');
        const newBtn = document.getElementById('new-btn');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        const findBtn = document.getElementById('find-btn');

        saveBtn.addEventListener('click', () => this.save());
        newBtn.addEventListener('click', () => this.newFile());
        undoBtn.addEventListener('click', () => this.undo());
        redoBtn.addEventListener('click', () => this.redo());
        findBtn.addEventListener('click', () => this.find());

        this.editor.addEventListener('input', () => {
          this.isSaved = false;
          this.updateStats();
          this.updateCursorPosition();
          this.pushToUndoStack();
        });

        this.editor.addEventListener('click', () => {
          this.updateCursorPosition();
        });

        this.editor.addEventListener('keyup', (e) => {
          if (e.key.startsWith('Arrow')) {
            this.updateCursorPosition();
          }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey || e.metaKey) {
            if (e.key === 's') {
              e.preventDefault();
              this.save();
            } else if (e.key === 'n') {
              e.preventDefault();
              this.newFile();
            } else if (e.key === 'z') {
              e.preventDefault();
              this.undo();
            } else if (e.key === 'y') {
              e.preventDefault();
              this.redo();
            } else if (e.key === 'f') {
              e.preventDefault();
              this.find();
            }
          }
        });
      }

      save() {
        const content = this.editor.value;

        console.log('[Notepad] Saving content:', content.substring(0, 50) + '...');

        // Send to parent for storage
        window.parent.postMessage({
          type: 'storage:set',
          pid: this.pid,
          data: {
            key: this.currentFile || 'notepad_content',
            value: content
          }
        }, '*');

        this.isSaved = true;
        this.updateStatus('Saved successfully');
        this.showNotification('Document saved');
      }

      autoSave() {
        console.log('[Notepad] Auto-saving...');
        this.save();
        this.updateStatus('Auto-saved');
      }

      newFile() {
        if (!this.isSaved) {
          const confirm = window.confirm('You have unsaved changes. Continue?');
          if (!confirm) return;
        }

        this.editor.value = '';
        this.currentFile = null;
        this.isSaved = true;
        this.undoStack = [];
        this.redoStack = [];
        this.lastContent = '';
        this.updateStats();
        this.updateStatus('New file');
      }

      pushToUndoStack() {
        const currentContent = this.editor.value;

        if (currentContent !== this.lastContent) {
          this.undoStack.push(this.lastContent);
          if (this.undoStack.length > 50) {
            this.undoStack.shift();
          }
          this.redoStack = [];
          this.lastContent = currentContent;
        }
      }

      undo() {
        if (this.undoStack.length === 0) return;

        const previousContent = this.undoStack.pop();
        this.redoStack.push(this.editor.value);
        this.editor.value = previousContent;
        this.lastContent = previousContent;
        this.updateStats();
        this.updateStatus('Undo');
      }

      redo() {
        if (this.redoStack.length === 0) return;

        const nextContent = this.redoStack.pop();
        this.undoStack.push(this.editor.value);
        this.editor.value = nextContent;
        this.lastContent = nextContent;
        this.updateStats();
        this.updateStatus('Redo');
      }

      find() {
        const searchTerm = prompt('Find:');
        if (!searchTerm) return;

        const content = this.editor.value;
        const index = content.toLowerCase().indexOf(searchTerm.toLowerCase());

        if (index !== -1) {
          this.editor.focus();
          this.editor.setSelectionRange(index, index + searchTerm.length);
          this.updateStatus(`Found: ${searchTerm}`);
        } else {
          this.updateStatus(`Not found: ${searchTerm}`);
          this.showNotification('Text not found');
        }
      }

      updateStats() {
        const content = this.editor.value;
        const words = content.trim() ? content.trim().split(/\s+/).length : 0;
        const chars = content.length;

        document.getElementById('word-count').textContent = `${words} word${words !== 1 ? 's' : ''}`;
        document.getElementById('char-count').textContent = `${chars} character${chars !== 1 ? 's' : ''}`;
      }

      updateCursorPosition() {
        const pos = this.editor.selectionStart;
        const content = this.editor.value.substring(0, pos);
        const lines = content.split('\n');
        const line = lines.length;
        const col = lines[lines.length - 1].length + 1;

        document.getElementById('cursor-position').textContent = `Line ${line}, Column ${col}`;
      }

      updateStatus(text) {
        document.getElementById('status-text').textContent = text;
        setTimeout(() => {
          document.getElementById('status-text').textContent = 'Ready';
        }, 3000);
      }

      showNotification(text) {
        const notification = document.getElementById('notification');
        notification.textContent = text;
        notification.classList.add('show');

        setTimeout(() => {
          notification.classList.remove('show');
        }, 2000);
      }

      notifyParentReady() {
        console.log('[Notepad] Notifying parent: app ready');
        window.parent.postMessage({
          type: 'app:ready',
          pid: this.pid
        }, '*');
      }
    }

    // Initialize notepad
    const notepad = new Notepad();
    console.log('[Notepad] App initialized');
  </script>
</body>
</html>
